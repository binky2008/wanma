<!DOCTYPE html>
<html> 
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>    
<meta charset="UTF-8">
<title>寄件排车管理</title>

<link rel="stylesheet" href="css/wanma.css">

<link rel="stylesheet" href="../tools/easyui/themes/default/easyui.css">
<link rel="stylesheet" href="../tools/easyui/themes/icon.css">

<script src="../tools/easyui/jquery.min.js"></script>
<script src="../tools/easyui/jquery.easyui.min.js"></script>
<script src="../tools/easyui/easyui-lang-zh_CN.js"></script>

<script src="js/common.js"></script>

<STYLE type="text/css">


		 
</STYLE>

<script type="text/javascript">


$(function(){
	init();

});

function init() {
	showGL();
	showGrid1();
	showGrid2();

	$('#param1').combobox( {
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name',
        data: [ 
        	{"id": 1, "name": "20:00/7.2"}, 
        	{"id": 2, "name": "22:00/7.2"}, 
        	{"id": 3, "name": "23:00/9.6"}
        ]
    });

	$('#param2').combobox( {
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name',
        data: [ 
        	{"id": 1, "name": "浙A-99999/7.2"}, 
        	{"id": 2, "name": "浙A-1212D/7.2"}, 
        	{"id": 3, "name": "浙A-21312/9.6"}
        ]
    });
}

function showGL() {
	var rows = [
        { "name": "日期", "group": "今日录单", "value": "2015-10-01" },
        { "name": "票数", "group": "今日录单", "value": "30" },
        { "name": "实际重量", "group": "今日录单", "value": "3000kg" },
        { "name": "实际体积", "group": "今日录单", "value": "8立方" },

        { "name": "票数", "group": "未完成班次关联货物", "value": "10" },
        { "name": "实际重量", "group": "未完成班次关联货物", "value": "1000kg" },
        { "name": "实际体积", "group": "未完成班次关联货物", "value": "3立方" },

        { "name": "班次号：20:00/9.6", "group": "班次关联情况", "value": "已关联" },
        { "name": "班次号：23:00/9.6", "group": "班次关联情况", "value": "未关联" }
    ];

	$('#tt').propertygrid({
        width: 298,
        height: 'auto',
        showGroup: true,
        scrollbarSize: 0,
        columns: [[
                { field: 'name', title: '名称', width: 100, resizable: true },
                { field: 'value', title: '值', width: 100, resizable: false }
        ]]
    });
    $('#tt').propertygrid('loadData', rows);
}


var FIELDS_1 = [
	    { field : 'ck', checkbox: true },
	    { field : 'f1', title : '客户名称', width : 80 },
	    { field : 'f2', title : '客户单号', width : 90 },
	    { field : 'f3', title : '运单号', width : 100 },
	    { field : 'f4', title : '目的地', width : 80 },
	    { field : 'f5', title : '货物数量', width : 80 },
	    { field : 'f6', title : '货物体积（立方）', width : 120 },
	    { field : 'f7', title : '货物重量（kg）', width : 100 },
	    { field : 'f8', title : '计费重量（kg）', width : 100 },
	    { field : 'f9', title : '目的站点', width : 80 },
	    { field : 'fa', title : '付款方式', width : 80 },
	    { field : 'fb', title : '取件员', width : 80 },
	    { field : 'fc', title : '提货车辆', width : 80 },
	    // { field : 'fd', title : '班次', width : 100 }
	];

function showGrid1(row){   
	var params = {}; 
	if(row) {
		// TODO 重新排班时，把已经做关联的货量查出来，自动勾选上
		params.bcID = row.id;
	}
 

    $('#t1').datagrid({
        url : 'data/jijian_0.json',
        method : 'get',
        queryParams : params, // 参数 "bcID": 12
        fit : true,
        fitColumns : true,
        rownumbers : true,
        singleSelect : false,
        columns : [FIELDS_1],
        onLoadSuccess: function(data) {
            $.each(data.rows, function(i, item) {
                // 默认选中
                // $('#t1').datagrid("selectRecord", id);
                if(row) {
                	if( item._checked ) $('#t1').datagrid("selectRow", i);
                } 
                else {
                	// $('#t1').datagrid("selectRow", i);
                }              
            });
        }
    }); 
}

var FIELDS_2 = [
	    { field : 'truckScheduleCode', title : '寄件班次', width : 90 },
	    { field : 'truckCode', title : '车牌号', width : 80 },
	    { field : 'truckType', title : '车型', width : 80 },
	    { field : 'businessorName', title : '业务员', width : 80 },
	    { field : 'weight', title : '重量', width : 80 },
	    { field : 'cubic', title : '体积', width : 80 },
	    { field : 'num', title : '件数', width : 80 },
	    { field : 'f8', title : '编辑', width : 100, align: "center" }
	];

function showGrid2(){    
    $.getJSON('data/jijian_1.json', {}, function(data){
        $.each(data, function(i, item){
            item.f8 = '<a href="javascript:void(0)" onclick="recombine('+i+')">重新选择货量</a>';
            item.truckScheduleCode = item.truckSchedule.code;
            item.truckCode = item.truck.code;
            item.truckType = item.truck.type.text;
            item.businessorName = item.businessor.name;
        });

        $('#t2').datagrid({
	        fit : true,
	        fitColumns : true,
	        rownumbers : true,
	        singleSelect : true,
	        columns : [FIELDS_2],
	        data: data
	    });
    });
}

function recombine(index) {
	$('#t2').datagrid("selectRow", index);
	var selectRow = $('#t2').datagrid("getSelected");

	if(selectRow) {
		showGrid1( selectRow );
		$('#param1').combobox("setValue", selectRow.truckSchedule.id);
		$('#param2').combobox("setValue", selectRow.truck.id);
	}
}

function combine() {
	var truckSchedule = $('#param1').combobox("getValue");
	if( !truckSchedule ) {
		$.messager.show({ title: '提示', msg: '请选择班次。'});
	    return;
	}

	var truck = $('#param2').combobox("getValue");
	if( !truck ) {
		$.messager.show({ title: '提示', msg: '请选择车辆。'});
	    return;
	}

	var selectedRows = $('#t1').datagrid("getSelections");
	if(selectedRows.length == 0) {
		$.messager.show({ title: '提示', msg: '您还没有选中任何货量。' });
	    return;
	}

	$.messager.show({
        title: '提示',
        msg: '已经成功关联本次选择的货量，共有'+ selectedRows.length +'票货.您可以继续对剩余的货量进行排班关联。'
    });

    // TODO 刷新货量Grid列表，隐藏已经关联的货量
}
	
</script>


</head>

<body>

	<div id="main" class="easyui-layout" fit="true" >
    	<div data-options="region:'west'" style="width:270px" border="true" title="概览">
            <table id="tt" border="false"></table>

            <div style="padding:10px; line-height:33px; text-align:center;">
	            <label>班次:&nbsp;&nbsp;</label><input id="param1" class="easyui-textbox" style="width: 180px;"/>
	            <br>
	            <label>车辆:&nbsp;&nbsp;</label><input id="param2" class="easyui-textbox" style="width: 180px;"/>
	            <div style="margin-top: 6px;">
		            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="combine()" >进行班次关联</a>&nbsp;&nbsp;
		            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-reload'" onclick="init()" >刷新</a>
	            </div>
            </div>
        </div>

        <div id="dataContainer" data-options="region:'center'" border="false">
            <div id="main" class="easyui-layout" fit="true" >
            	<!--
		        <div id="queryContainer" data-options="region:'north'" border="false">
		            <label>班次:</label><input id="param1" class="easyui-textbox" style="width: 180px;" />
		            <label>车辆:</label><input id="param2" class="easyui-textbox" style="width: 180px;" />
		            &nbsp;&nbsp;&nbsp;&nbsp;
		            <a href="#" class="easyui-linkbutton" onclick="combine()">进行班次关联</a>
		        </div>
		        -->
		        <div id="dataContainer" data-options="region:'center'" border="false" title="待关联货量信息">
		            <table id="t1" border="false"></table>
		        </div>
		        <div data-options="region:'north'" style="height:200px" border="false" title="已关联班次列表">
		            <table id="t2" border="false"></table>
		        </div>
		    </div>
        </div>
    </div>

</body>
</html>
