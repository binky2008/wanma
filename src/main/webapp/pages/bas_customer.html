<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>客户管理</title>

<link rel="stylesheet" href="css/wanma.css">

<link rel="stylesheet" href="../tools/easyui/themes/default/easyui.css">
<link rel="stylesheet" href="../tools/easyui/themes/icon.css">

<script src="../tools/easyui/jquery.min.js"></script>
<script src="../tools/easyui/jquery.easyui.min.js"></script>
<script src="../tools/easyui/easyui-lang-zh_CN.js"></script>

<script src="js/common.js"></script>

<link rel="stylesheet" href="css/region.css" />
<script src="js/region.js"></script>

<style>
.panel {
    overflow: visible;
}
</style>

<script type="text/javascript">

// 定时从V5同步网点的客户信息，还需要能触发手动同步。 网点员工登陆时自动同步一遍

BASE_URL = '../customer';
GET_URL   = BASE_URL + '/';  //{id}
SAVE_URL  = BASE_URL;
DELTE_URL = BASE_URL + '/';  //{id}
QUERY_URL = BASE_URL + '/query';

$(document).ready(function(){
    query();

    $('#ownerSiteId').combobox( {
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name',
        data: [window.parent.ownerSite]
    }).textbox('readonly', true);

    $('#businessorId').combobox( {
        url: '../employee/site/' + window.parent.ownerSite.id,
        method : 'get',
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name' 
    });

    $('#settleType').combobox( {
        panelHeight: '60px',
        valueField: 'name',
        textField: 'name',
        data: [{"name": "月结"}, {"name": "现付"}] 
    });

    $('#param4').combobox( {
        panelHeight: '60px',
        valueField: 'name',
        textField: 'name',
        data: [{"name": "月结"}, {"name": "现付"}] 
    });

    $('#param5').combobox( {
        url: '../employee/site/' + window.parent.ownerSite.id,
        method : 'get',
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name' 
    });

    /** 加载省市区 */
    $("#aa").Address({
        callback: function (infos, selected_ids) {
            var str = '';
            for (var i = 0; i < infos.length; i++) {
                str = str + infos[i];
            }
            $('#aa input').val(str);
        }
    });
});

function create(){
    openDialog('新增客户', true);

    $('#lockVersion').val('0'); //給版本号设置默认值.
    $('#original').val('手动新增'); 

    $('#ownerSiteId').combobox('setValue', window.parent.ownerSite.id);
    
    $('#_code').textbox('readonly', true);

    $.post(BASE_URL + '/getNewCode', {'siteId': window.parent.ownerSite.id}, function (data) {
        $('#_code').textbox("setValue", data).textbox('readonly', true);
    });
}

function update(){
    var row = getSelectedRow();
    if (row){
        openDialog('修改客户信息');

        $.get(GET_URL + row.id, {}, function(data){
            if(data.settleType) data['settleType.id'] = data.settleType.id;
            data['ownerSite.id'] = data.ownerSite.id;
            if(data.businessor) data['businessor.id'] = data.businessor.id;

            data.needMessage = data.needMessage ? "1" : "0";

            $('#fm').form('load', data);
            $('#_code').textbox('readonly', true);
        });
    }
}

var FIELDS_1 = [
    { field : 'ck', checkbox: true },
    { field : 'code', title : '客户编码', width : 90 },
    { field : 'name', title : '客户名称', width : 80 },
    { field : 'original', title : '客户来源', width : 70 },
    { field : 'settleType', title : '结算方式', width : 60 }    
], FIELDS_2 = [
    { field : 'contacts', title : '联系人', width : 80 },
    { field : 'phone1', title : '联系电话1', width : 100 },
    { field : 'phone2', title : '联系电话2', width : 80 },
    { field : 'address', title : '寄件地址', width : 200 },
    { field : 'ownerSiteName', title : '所属站点', width : 80 },
    { field : 'industry', title : '所属行业', width : 80 },
    { field : 'fullName', title : '客户全称', width : 80 },  
    { field : 'customerType', title : '客户类型', width : 70 },
    { field : 'businessorName', title : '业务员', width : 60 },
    { field : 'needMessage', title : '是否发送消息', width : 80 },
    { field : 'stateName', title : '状态', width : 60 }
];

/**
 * 可用于第一次加载数据,也可用于查询;
 * 第一次加载数据页面时参数为空.
 */
function query(params) {
    params = params || {};
    params.ownerSiteId = window.parent.ownerSite.id;

    $('#t1').datagrid({
        url : QUERY_URL, // 数据地址
        queryParams : params, // 参数
        fit : true,
        fitColumns : false,
        pagination : true,
        pageSize : 30,
        rownumbers : true,
        singleSelect : true,
        checkOnSelect : true,
        selectOnCheck : true,
        toolbar: [ 
            { text: '同步V5客户', handler: syncV5 }, 
            '-', { text: '新增', iconCls: 'icon-add', handler: create }, 
            '-', { text: '修改', iconCls: 'icon-edit', handler: update, id: "btn2" }, 
            '-', { text: '删除', iconCls : 'icon-remove', handler : _remove, id: "btn3" }, 
            '-', { text: '停用客户', handler : disable }, 
            '-', { text: '导出', handler : _export }
        ] ,
        frozenColumns: [FIELDS_1], 
        columns : [FIELDS_2],
        /* 返回的结果再处理 */
        loadFilter : function(data) {
            $.each(data.rows, function(i, item) {
                item.needMessage = item.needMessage ? "是" : "否";
                item.stateName = item.disabled == 1 ? "停用" : "启用";
                item.typeName = item.type ? item.type.text : "普通客户";
                item.ownerSiteName  = item.ownerSite ? item.ownerSite.name : "";
                item.businessorName = item.businessor ? item.businessor.name : "";
            });
            return data;
        },
        onSelect: function(index, row) {
            if(row.customerType && row.customerType.trim() == '项目客户') {
                $('#btn2').linkbutton("disable");
                $('#btn3').linkbutton("disable");
            }
            else {
                $('#btn2').linkbutton("enable");
                $('#btn3').linkbutton("enable");
            }
        }
    });
}

function beginQuery() {
    var params = {};
    params.code = $('#param1').val();
    params.name = $('#param2').val();
    params.phone1 = $('#param3').val();
    params.settleType = $('#param4').textbox("getValue");
    params.businessorId = $('#param5').textbox("getValue");

    query(params);
}

// 网点登陆的时候自动同步V5的用户；同时支持手动同步
function syncV5() {
    $.post(BASE_URL + '/v5/sync', {'siteId': window.parent.ownerSite.id}, function (data) {
        $.messager.show({ title: '操作结果', msg: '同步成功' });
        query();
    });
}

function disable() {
    var row = getSelectedRow();
    row && $.messager.confirm('Confirm', '您确定要停用该客户吗?', function(result){
        result && $.post('../customer/disable/' + row.id, {}, function (result) {
            checkException(result, function() {
                $.messager.show({ title: '操作结果', msg: '停用成功' });
                $('#t1').datagrid('reload'); // reload the employee data
            });
        });
    });
}

</script>

</head>
<body>

    <div id="main" class="easyui-layout" fit="true" >
        <div id="queryContainer" data-options="region:'north'" border="false">
            <label>客户编码:</label><input id="param1" class="easyui-textbox" />
            <label>客户名称:</label><input id="param2" class="easyui-textbox" />
            <label>联系电话:</label><input id="param3" class="easyui-textbox" />
            <label>结算类型:</label><input id="param4" class="easyui-textbox" />
            <label>业务员:</label><input id="param5" class="easyui-textbox" />

            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="beginQuery()">查询</a>
        </div>
        <div id="dataContainer" data-options="region:'center'" border="false" title="客户列表">
            <table id="t1" border="false"></table>
        </div>
    </div>

    <div id="dlg" class="easyui-dialog" style="width:800px;height:290px;" closed="true" buttons="#dlg-buttons">
        <form id="fm" method="post" novalidate>
            <input name="id" type="hidden" />
            <input id="lockVersion" name="lockVersion" type="hidden" />
            <input id="disabled" name="disabled" type="hidden" />
            <input id="original" name="original" type="hidden" />
            <input id="seqNo" name="seqNo" type="hidden" />
            <table>
                <tr>
                    <td class="label">客户编码:</td>
                    <td>
                        <input name="code" id="_code" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">客户名称:</td>
                    <td>
                        <input name="name" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">客户全称:</td>
                    <td>
                        <input name="fullName" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">联系人:</td>
                    <td>
                        <input name="contacts" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">联系电话1:</td>
                    <td>
                        <input name="phone1" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">联系电话2:</td>
                    <td>
                        <input name="phone2" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">所属站点:</td>
                    <td>
                        <input name="ownerSite.id" id="ownerSiteId" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">业务员:</td>
                    <td>
                        <input name="businessor.id" id="businessorId" class="easyui-textbox" />
                    </td>
                    <td class="label">结算类型:</td>
                    <td>
                        <input name="settleType" id="settleType" class="easyui-textbox" required="true" />
                    </td>
                </tr>
                <tr>
                    <td class="label">所在地区:</td>
                    <td colspan="3">
                        <div id="aa" class="cc">
                        <input name="region" id="region" class="easyui-textbox" style="width: 300px;" prompt="请选择省市区" ></div>
                    </td>
                    <td class="label">所属行业:</td>
                    <td>
                        <input name="industry" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">详细地址:</td>
                    <td colspan="3">
                        <input name="address" id="address" class="easyui-textbox" style="width: 420px;" required="true" />
                    </td>
                    <td class="label">发送消息:</td>
                    <td>
                        <input name="needMessage" id="_needMessage" type="radio" value="1" checked />
                        <label>是</label>
                        <input name="needMessage" type="radio" value="0" />
                        <label>否</label>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="dlg-buttons">
        <a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="save()">保存</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="closeDialog()">取消</a>
    </div>

</body>
</html>