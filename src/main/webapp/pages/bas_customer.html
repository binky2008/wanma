<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>客户管理</title>

<link rel="stylesheet" type="text/css" href="css/wanma.css">

<link rel="stylesheet" type="text/css" href="../tools/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../tools/easyui/themes/icon.css">

<script type="text/javascript" src="../tools/easyui/jquery.min.js"></script>
<script type="text/javascript" src="../tools/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../tools/easyui/easyui-lang-zh_CN.js"></script>

<script src="js/common.js"></script>

<link rel="stylesheet" href="css/region.css" />
<script type="text/javascript" src="js/region.js"></script>

<style>
.panel {
    overflow: visible;
}
</style>

<script type="text/javascript">

BASE_URL = '../customer';
GET_URL   = BASE_URL + '/';  //{id}
SAVE_URL  = BASE_URL;
DELTE_URL = BASE_URL + '/';  //{id}
QUERY_URL = BASE_URL + '/query';

$(document).ready(function(){
    query();

    initCombobox('settleTypeId', 'SettleType');

    $('#ownerSiteId').combobox( {
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name',
        data: [window.parent.ownerSite]
    }).textbox('readonly', true);

    $('#businessorId').combobox( {
        url: '../employee/site/' + window.parent.ownerSite.id,
        method : 'get',
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name' 
    });

    $('#param5').combobox( {
        url: '../employee/site/' + window.parent.ownerSite.id,
        method : 'get',
        panelHeight: '60px',
        valueField: 'id',
        textField: 'name' 
    });

    /** 加载省市区 */
    $("#aa").Address({
        callback: function (infos, selected_ids) {
            var str = '';
            for (var i = 0; i < infos.length; i++) {
                str = str + infos[i];
            }
            $('#aa input').val(str);
        }
    });
});

function create(){
    $('#fm').form('clear');
    $('#dlg').dialog('open').dialog('setTitle','新增客户').dialog('center');
    $('#lockVersion').val('0'); //給版本号设置默认值.
    $('#original').val('手动新增'); 

    $('#ownerSiteId').combobox('setValue', window.parent.ownerSite.id);
    
    $('#_code').textbox('readonly', true);

    $.post('../customer/getNewCode', {'siteId': window.parent.ownerSite.id}, function (data) {
        $('#_code').textbox("setValue", data).textbox('readonly', true);
    });
}

function update(){
    var row = getSelectedRow();
    if (row){
        $('#dlg').dialog('open').dialog('setTitle','修改客户信息').dialog('center');

        $.get(GET_URL + row.id, {}, function(data){
            if(data.settleType) data['settleType.id'] = data.settleType.id;
            data['ownerSite.id'] = data.ownerSite.id;
            if(data.businessor) data['businessor.id'] = data.businessor.id;

            data.needMessage = data.needMessage ? "1" : "0";

            $('#fm').form('load', data);
            $('#_code').textbox('readonly', true);
        });
    }
}

var CUSTOMER_FIELDS = [
    { field : 'ck', checkbox: true },
    { field : 'code', title : '客户编码', width : 90 },
    { field : 'original', title : '客户来源', width : 70 },
    { field : 'name', title : '客户名称', width : 80 },
    { field : 'fullName', title : '客户全称', width : 80 },
    { field : 'settleTypeName', title : '结算方式', width : 60 },
    { field : 'contacts', title : '联系人', width : 80 },
    { field : 'phone1', title : '联系电话1', width : 80 },
    { field : 'phone2', title : '联系电话2', width : 80 },
    { field : 'address', title : '寄件地址', width : 130 },
    { field : 'ownerSiteName', title : '所属站点', width : 80 },
    { field : 'industry', title : '所属行业', width : 80 },
    { field : 'businessorName', title : '业务员', width : 60 },
    { field : 'needMessage', title : '是否发送消息', width : 80 },
    { field : 'stateName', title : '状态', width : 60 }
];

/**
 * 可用于第一次加载数据,也可用于查询;
 * 第一次加载数据页面时参数为空.
 */
function query(params) {
    params = params || {};
    $('#t1').datagrid({
        url : QUERY_URL, // 数据地址
        queryParams : params, // 参数
        fit : true,
        fitColumns : true,
        pagination : true,
        pageSize : 30,
        rownumbers : true,
        singleSelect : true,
        checkOnSelect : true,
        selectOnCheck : true,
        toolbar: [ 
            { text: '同步V5', handler: syncV5 }, 
            '-', { text: '新增', iconCls: 'icon-add', handler: create }, 
            '-', { text: '修改', iconCls: 'icon-edit', handler: update }, 
            '-', { text: '删除', iconCls : 'icon-remove', handler : _remove }, 
            '-', { text: '停用客户', handler : disable }, 
            //'-', { text: '导出', handler : _export }
        ] ,
        columns : [CUSTOMER_FIELDS],
        /* 返回的结果再处理 */
        loadFilter : function(data) {
            $.each(data.rows, function(i, item) {
                item.needMessage = item.needMessage ? "是" : "否";
                item.stateName = item.disabled == 1 ? "停用" : "启用";
                item.typeName = item.type ? item.type.text : "普通客户";
                item.settleTypeName = item.settleType ? item.settleType.text : "";
                item.ownerSiteName  = item.ownerSite ? item.ownerSite.name : "";
                item.businessorName = item.businessor ? item.businessor.name : "";
            });
            return data;
        }
    });
}

/**
 * 收集查询的条件
 */
function beginQuery() {
    var params = {};
    params.code = $('#param1').val();
    params.name = $('#param2').val();
    params.phone1 = $('#param3').val();
    params.original = $('#param4').val();
    params.businessorId = $('#param5').textbox("getValue");;

    query(params);
}

// 网点登陆的时候自动同步V5的用户；同时支持手动同步
function syncV5() {

}

function disable() {
    var row = getSelectedRow();
    row && $.messager.confirm('Confirm', '您确定要停用该客户吗?', function(result){
        result && $.post('../customer/disable/' + row.id, {}, function (result) {
            checkException(result, function() {
                $.messager.show({ title: '操作结果', msg: '停用成功' });
                $('#t1').datagrid('reload'); // reload the employee data
            });
        });
    });
}

</script>

</head>
<body>

    <div id="main" class="easyui-layout" fit="true" >
        <div id="queryContainer" data-options="region:'north'" border="false">
            <label>客户编码:</label><input id="param1" class="easyui-textbox" />
            <label>客户名称:</label><input id="param2" class="easyui-textbox" />
            <label>联系电话:</label><input id="param3" class="easyui-textbox" />
            <label>客户来源:</label><input id="param4" class="easyui-textbox" />
            <label>业务员:</label><input id="param5" class="easyui-textbox" />

            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="beginQuery()">查询</a>
        </div>
        <div id="dataContainer" data-options="region:'center'" border="false" title="客户列表">
            <table id="t1" border="false"></table>
        </div>
    </div>

    <div id="dlg" class="easyui-dialog" style="width:800px;height:290px;" closed="true" buttons="#dlg-buttons">
        <form id="fm" method="post" novalidate>
            <input name="id" type="hidden" />
            <input id="lockVersion" name="lockVersion" type="hidden" />
            <input id="disabled" name="disabled" type="hidden" />
            <input id="original" name="original" type="hidden" />
            <input id="seqNo" name="seqNo" type="hidden" />
            <table>
                <tr>
                    <td class="label">客户编码:</td>
                    <td>
                        <input name="code" id="_code" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">客户名称:</td>
                    <td>
                        <input name="name" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">客户全称:</td>
                    <td>
                        <input name="fullName" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">联系人:</td>
                    <td>
                        <input name="contacts" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">联系电话1:</td>
                    <td>
                        <input name="phone1" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">联系电话2:</td>
                    <td>
                        <input name="phone2" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">所属站点:</td>
                    <td>
                        <input name="ownerSite.id" id="ownerSiteId" class="easyui-textbox" required="true" />
                    </td>
                    <td class="label">业务员:</td>
                    <td>
                        <input name="businessor.id" id="businessorId" class="easyui-textbox" />
                    </td>
                    <td class="label">结算类型:</td>
                    <td>
                        <input name="settleType.id" id="settleTypeId" class="easyui-textbox" required="true" />
                    </td>
                </tr>
                <tr>
                    <td class="label">所在地区:</td>
                    <td colspan="3">
                        <div id="aa" class="cc"><input name="region" class="easyui-textbox" style="width: 300px;" value="" prompt="请选择省市区" ></div>
                    </td>
                    <td class="label">所属行业:</td>
                    <td>
                        <input name="industry" class="easyui-textbox" />
                    </td>
                </tr>
                <tr>
                    <td class="label">详细地址:</td>
                    <td colspan="3">
                        <input name="address" id="address" class="easyui-textbox" style="width: 420px;" required="true" />
                    </td>
                    <td class="label">发送消息:</td>
                    <td>
                        <input name="needMessage" id="_needMessage" type="radio" value="1" checked />
                        <label>是</label>
                        <input name="needMessage" type="radio" value="0" />
                        <label>否</label>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="dlg-buttons">
        <a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="save()">保存</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="closeDialog()">取消</a>
    </div>

</body>
</html>