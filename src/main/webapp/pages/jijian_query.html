<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>寄件查询</title>

<link rel="stylesheet" href="css/wanma.css">

<link rel="stylesheet" href="../tools/easyui/themes/default/easyui.css">
<link rel="stylesheet" href="../tools/easyui/themes/icon.css">

<script src="../tools/tssJS/tssJS.js"></script>
<script src="../tools/tssJS/tssJS.ajax.js"></script>

<script src="../tools/easyui/jquery.min.js"></script>
<script src="../tools/easyui/jquery.easyui.min.js"></script>
<script src="../tools/easyui/datagrid-filter.js"></script>
<script src="../tools/easyui/easyui-lang-zh_CN.js"></script>

<script src="js/common.js"></script>

<style type="text/css">

</style>

<script type="text/javascript">

QUERY_URL_1 = BASE_DATA_URL + '697';
QUERY_URL_2 = BASE_DATA_URL + '699';

if(IS_TEST) {
    QUERY_URL_1 = 'data/jj_query_1.json';
    QUERY_URL_2 = 'data/jj_query_2.json';
}

$(document).ready(function(){

    query();

    initSiteList("param1");
    initSiteList("param5", true);

    $('#param1').combobox('setValue', window.parent.ownerSite.id);
});

var FIELDS_1 = [
        { field : '寄件日期', title : '寄件日期', width : 75, sortable: true},
        { field : '签收时间', title : '签收时间', width : 75 },
        { field : '客户名称', title : '客户名称', width : 60, sortable: true },
        { field : '运单号', title : '运单号', width : 90, align: "center", styler: 
            function(value, row, index){
                if (value) {  return 'cursor: pointer; color: blue;' ; }
            } 
        }, 
        { field : '在途信息', title : '在途信息', width : 280 }, 
        { field : '目的城市', title : '目的城市', width : 60 }
    ],
    FIELDS_2 = [
        { field : '异常件', title : '异常件', width : 70, align: "center" },
        { field : '新增费用', title : '新增费用', width : 70 },
        { field : '整体时效', title : '整体时效', width : 70, align: "center" },
        { field : '收到的评价', title : '收到的评价', width : 70 },
        { field : '评价他人', title : '评价他人', width : 70 },

        { field : '付款方式', title : '付款方式', width : 60 }, 
        { field : '寄件网点', title : '寄件网点', width : 70 },
        { field : '目的网点', title : '目的网点', width : 70 },
        { field : '入网分拨', title : '入网分拨', width : 70 },
        { field : '出网分拨', title : '出网分拨', width : 70 },
        
        { field : 'X1', title : '数量/体积/重量', width : 100 }, 
        { field : '计费重量', title : '计费重量', width : 70 }, 
        { field : '收件人信息', title : '收件人信息', width : 100 },  
        { field : '收件人地址', title : '收件人地址', width : 120 },      
        { field : '录单员', title : '录单员', width : 70, sortable: true }, 
        { field : '取件员', title : '取件员', width : 60 },
        { field : '来源及订单编号', title : '来源及订单编号', width : 90 }
    ];

function query(params) {
    var data1, data2;
    params = params || {};
    params.page = 1;
    params.rows = 1000;

    tssJS.ajax({
        url : QUERY_URL_1,            
        params : params, 
        method : METHOD,
        type : "json",
        waiting : true,
        ondata : function() {
            data1 = this.getResponseJSON();
            data1 && data2 && show(data1, data2); 
        }
    });   

    tssJS.ajax({
        url : QUERY_URL_2,
        params : params,
        method : METHOD,
        type : "json",
        waiting : true,
        ondata : function() {
            data2 = this.getResponseJSON();
            data1 && data2 && show(data1, data2); 
        }
    }); 
}

function show(data1, data2) {
    data1.rows.each(function(i, item1) {
        data2.rows.each(function(j, item2) {
            if(item1["运单号"] === item2.code) {
                item1["签收时间"] = item2.sign_date || "未签收";
                item1["delay"] = item2.delay;
                item1["在途信息"] = (item2.trans_status || "").replace(/\;/, "<br>");
                item1["目的城市"] = item2.destination;               
            }
        });
    });

    var dg = $('#t1').datagrid({
        data : data1,
        fit : true,
        fitColumns : false,
        pageSize : 1000,
        rownumbers : true,
        singleSelect : true,
        checkOnSelect : true,
        selectOnCheck : true,
        remoteSort : false,
        multiSort : true,
        nowrap: false,
        sortName : "寄件日期",
        sortOrder : "desc",
        frozenColumns: [FIELDS_1], 
        columns : [FIELDS_2],
        onHeaderContextMenu: function(e, field){
            e.preventDefault();
            if (!cmenu){
                createColumnMenu();
            }
            cmenu.menu('show', {left:e.pageX, top:e.pageY});
        },
        rowStyler: function(index, row) {
            if (row.hasW) {
                return 'background-color:red;';
            }
        },
        onClickCell: function(index, field, value) {
            if(field !== '运单号') return;
            $.messager.alert({
                title: '提示',
                msg: '打开运单【'+value+'】的《快件跟踪查询》'
            });
        },
        onDblClickRow: function(index, row) {
            $.messager.alert({
                title: '提示',
                msg: '打开运单【'+ row["运单号"] +'】的《快件跟踪查询》'
            });
        },
        loadFilter : function(data) {
            $.each(data.rows, function(i, item) {                
                // 初次（后续排序、过滤，还会执行loadFilter）
                if( !item["X1"] ) {
                    item["寄件日期"] = item["寄件日期"].replace(" 00:00:00", "");
                    item["X1"] = item["件数"] + "/" + item["体积"] + "/" + item["重量"];
            
                    var wtj = item["异常件"] || "";
                    item["异常件"] = "";
                    if(wtj.indexOf("NEW") >= 0) {
                        item["异常件"] = '<b class="process pc1">未</b>';
                    }
                    if(wtj.indexOf("PROCESSING") >= 0) {
                        item["异常件"] += '<b class="process pc2">中</b>';
                    }
                    if(wtj.indexOf("FINISH") >= 0) {
                        item["异常件"] += '<b class="process pc3">完</b>';
                    }

                    if(item.delay) {
                        if(item.delay >= 24 && item.delay < 48) {
                            item["整体时效"] = '<b class="sxcs c24">超24</b>';
                        }
                        if(item.delay >= 48 && item.delay < 72) {
                            item["整体时效"] = '<b class="sxcs c48">超48</b>';
                        }
                        if(item.delay >= 72) {
                            item["整体时效"] = '<b class="sxcs c72">超72</b>';
                        }
                    }
                }
            });
            return data;
        }
    });

    dg.datagrid('enableFilter');
}

function moreParams() {
    $("#mp").show();
    $("#queryContainer").css("height", "120px");
}

function lessParams() {
    $("#mp").hide();
    $("#queryContainer").css("height", "35px");
}

function beginQuery() {
    $("#dataContainer").html('<table id="t1" border="false"></table>');

    var params = {};

    var site = $('#param1').textbox("getValue");
    if( site ) { params.param1 = site; } 
    else { return $.messager.show({ title: '提示', msg: '请选择寄件网点' }); }

    params.param2 = $('#param2').val();

    params.param3 = $('#param3').val() || "today-7";
    params.param4 = $('#param4').val() || "today+1";

    params.param5 = $('#param5').val();
    params.param6 = $('#param6').val();
    params.param7 = $('#param7').val();
    params.param8 = $('#param8').val();

    query(params);
    lessParams();
}

</script>

</head>
<body>
    <div id="main" class="easyui-layout" fit="true" >
        <div id="queryContainer" data-options="region:'north'" border="false">
            <label>寄件网点:</label><input id="param1" class="easyui-textbox" required="true"/>
            <label>查询条件:</label>
            <input id="param2" class="easyui-textbox" data-options="prompt:'运单号/客户名称'" style="width:400px"/>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick='beginQuery()'>查询</a>&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" onclick='moreParams()'>更多查询条件</a>

            <div id="mp">
                <label>寄件日期从:</label><input id="param3" class="easyui-datebox"/>
                <label>目的站点:</label><input id="param5" class="easyui-textbox"/>
                <label>录单员:</label><input id="param6" class="easyui-textbox"/>
                <br>
                <label>寄件日期到:</label><input id="param4" class="easyui-datebox"/>               
                <label>目的分拨:</label><input id="param7" class="easyui-textbox"/>              
                <label>取件员:</label><input id="param8" class="easyui-textbox"/>
                &nbsp;&nbsp;
                <a href="#" class="easyui-linkbutton" onclick='lessParams()'>收起更多查询条件</a>
            </div>
        </div>
        <div id="dataContainer" data-options="region:'center'" border="false" title="寄件运单综合查询">
            <table id="t1" border="false"></table>
        </div>
        <div id="decrContainer" data-options="region:'south'" border="false" style="height:25px;">
            <i>说明:</i>
            <b class="sxcs c24">超24</b>时效超过24小时
            <b class="sxcs c48">超48</b>时效超过48小时
            <b class="sxcs c72">超72</b>时效超过72小时
            &nbsp;&nbsp;
            <b class="process pc1">未</b>未处理
            <b class="process pc2">中</b>处理中
            <b class="process pc3">完</b>处理完成
        </div>
    </div>

</body>
</html>