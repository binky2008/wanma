<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Demo</title>
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">

    <script type="text/javascript" src="../../tools/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../tools/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../tools/easyui/easyui-lang-zh_CN.js"></script>

    <style type="text/css">
        #dlg {
            padding:3px
        }
        #dlg-buttons a {
            width: 90px;
        }

        #queryContainer {
            height:40px;
            padding:8px 0 0 10px;
        }
        #queryContainer input { width: 180px; }

        #fm table {
            border-collapse: collapse;
        }
        #fm table td {
            border: 1px solid #999;
            padding: 5px;
        }

        #fm table { border: 1px solid #999; }
        #fm table tr { height: 40px; }

        #fm table .label {
            background-color: #eee;
            width:60px;
            text-align: right;
        }
        #fm table input.easyui-textbox {
            width:172px;
        }

    </style>

    <script type="text/javascript">

$(document).ready(function(){
    initCombobox('stateId', 'DemoState');
    initCombobox('param3', 'DemoState');

    query();
});

function initCombobox(id, code, params) {
    var url = '../../param/json/combo/' + code;
    $.get(url, params, function(data){
        var _data = [];
        $.each(data, function(i, item){
            _data.push({'id': item[0], 'text': item[1]});
        });

        $('#' + id).combobox( {
                    panelHeight: '120px',
                    valueField: 'id',
                    textField: 'text',
                    data: _data
                });
    });
}

function create(){
    $('#dlg').dialog('open').dialog('setTitle','新增').dialog('center');
    $('#fm').form('clear');
}

function update(){
    var row = $('#t1').datagrid('getSelected');
    if (row){
        $('#dlg').dialog('open').dialog('setTitle','修改').dialog('center');

        $.get("../../demo/" + row.id, {}, function(data){
            data['state.id'] = data.state.id;
            $('#fm').form('load', data);
        });
    }
    else {
        $.messager.alert({
            title: '提示',
            msg: '您没有选中任何行，请先点击选中需要修改的行。'
        });
    }
}

function saveUser(){
    $('#fm').form('submit',{
        url: '../../demo',
        onSubmit: function(){
            return $(this).form('validate');
        },
        success: function(result){
            var result = eval('(' + result + ')');
            if (result.errorMsg){
                $.messager.show({
                    title: 'Error',
                    msg: result.errorMsg
                });
            } else {
                $('#dlg').dialog('close'); // close the dialog
                $('#t1').datagrid('reload'); // reload the grid data
            }
        }
    });
}

function _remove(){
    var row = $('#t1').datagrid('getSelected');
    if (row){
        $.messager.confirm('Confirm','您确定要删除这行数据吗?', function(r){
            $.ajax({
                 url: '../../demo/' + row.id,
                 type: 'DELETE',
                 success: function(result) {
                    $('#t1').datagrid('reload'); // reload the user data
                 }
            });
        });
    }
    else {
        $.messager.alert({
            title: '提示',
            msg: '您没有选中任何行，请先点击选中需要删除的行。'
        });
    }
}


var FIELDS_1 = [
        { field : 'id', title : 'ID', width : 90},
        { field : 'name', title : '名称', width : 90 },
        { field : 'code', title : '编码', width : 80 },
        { field : 'stateName', title : '状态', width : 80 },
        { field : 'udf1', title : '自定义1', width : 80 }, 
        { field : 'udf2', title : '自定义2', width : 80 }, 
        { field : 'udf3', title : '自定义3', width : 80 }
    ];

function query(params) {
    params = params || {};

    $('#t1').datagrid({
        url: '../../demo/query',
        queryParams: params,
        fit : true,
        fitColumns : true,
        pagination : true,
        rownumbers : true,
        singleSelect : true,
        toolbar: "#toolbar",
        columns : [FIELDS_1],
        loadFilter: function(data){
            $.each(data.rows, function(i, item){
                item.stateName = item.state.text;
            });
            return data;
        }
    });
}

function beginQuery() {
    var params = {};
    params.code = $('#param1').val();
    params.name = $('#param2').val();
    params.stateId = $('#param3').textbox("getValue");
    query(params);
}

    </script>

</head>
<body>
    <div id="main" class="easyui-layout" fit="true" >
        <div id="queryContainer" data-options="region:'north'" border="false">
            <label>编码：</label>
            <input id="param1" class="easyui-textbox"></input>&nbsp;
            <label>名称：</label>
            <input id="param2" class="easyui-textbox"></input>&nbsp;
            <label>状态：</label>
            <input id="param3" class="easyui-textbox"></input>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick='beginQuery()'>查询</a>
        </div>
        <div id="dataContainer" data-options="region:'center'" border="false" title="数据列表">
            <table id="t1" border="false"></table>
            <div id="toolbar">
                <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="create()">新建</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="update()">修改</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="_remove()">删除</a>
            </div>
        </div>
    </div>

    <div id="dlg" class="easyui-dialog" style="width:800px;height:200px;" closed="true" buttons="#dlg-buttons">
        <form id="fm" method="post" novalidate>
            <input name="id" type="hidden">
            <table>
                <tr>
                    <td class="label">编码:</td>
                    <td>
                        <input name="code" class="easyui-textbox" required="true">
                    </td>
                    <td class="label">名称:</td>
                    <td>
                        <input name="name" class="easyui-textbox" required="true">
                    </td>
                    <td class="label">状态:</td>
                    <td>
                        <input name="state.id" id="stateId" class="easyui-textbox" required="true">
                    </td>
                </tr>
                <tr>
                    <td class="label">自定义1:</td>
                    <td>
                        <input name="udf1" class="easyui-textbox">
                    </td>
                    <td class="label">自定义2:</td>
                    <td>
                        <input name="udf2" class="easyui-textbox">
                    </td>
                    <td class="label">自定义3:</td>
                    <td>
                        <input name="udf3" class="easyui-textbox" validType="email">
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="dlg-buttons">
        <a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="saveUser()">保存</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" >取消</a>
    </div>

</body>
</html>